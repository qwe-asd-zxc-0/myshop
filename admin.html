<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†ç³»ç»Ÿ - GCI Admin</title>
    <style>
        /* --- æ ·å¼ä¿æŒä¸å˜ --- */
        :root { --primary-color: #d32f2f; --primary-dark: #b71c1c; --bg-color: #f4f6f8; --sidebar-width: 240px; --header-height: 60px; --text-main: #333; }
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: var(--sidebar-width); background-color: #263238; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { height: var(--header-height); display: flex; align-items: center; justify-content: center; background-color: #1b2428; font-weight: bold; font-size: 18px; box-shadow: 0 1px 0 rgba(255,255,255,0.05); }
        .nav-menu { list-style: none; padding: 20px 0; margin: 0; }
        .nav-item { padding: 15px 25px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; opacity: 0.8; border-left: 4px solid transparent; }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); opacity: 1; }
        .nav-item.active { background-color: #37474f; border-left-color: var(--primary-color); opacity: 1; }
        .nav-item.home-link { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); background-color: #1b2428; }
        .nav-item.home-link:hover { background-color: #d32f2f; opacity: 1; }
        .nav-icon { margin-right: 12px; font-size: 18px; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: var(--header-height); background-color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; padding: 0 30px; z-index: 10; }
        .breadcrumb { font-size: 14px; color: #666; }
        .admin-profile { display: flex; align-items: center; gap: 15px; }
        .admin-badge { background: #ffebee; color: var(--primary-color); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .content-body { padding: 30px; overflow-y: auto; flex: 1; }

        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 30px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
        .card-title { font-size: 18px; font-weight: bold; margin: 0; color: #2c3e50; }
        
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-danger { background-color: #ffebee; color: #c62828; }
        .btn-danger:hover { background-color: #ffcdd2; }
        .btn-edit { background-color: #e3f2fd; color: #1565c0; margin-right: 5px; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 14px 15px; border-bottom: 1px solid #eee; }
        th { background-color: #fafafa; color: #666; font-weight: 600; font-size: 13px; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .bg-success { background-color: #e8f5e9; color: #2e7d32; }
        .bg-warning { background-color: #fff3e0; color: #ef6c00; }
        .bg-danger { background-color: #ffebee; color: #c62828; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 500px; padding: 30px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 13px; color: #555; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .form-control:focus { border-color: var(--primary-color); outline: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">GCI ADMIN</div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="switchTab('products', this)">
                <span class="nav-icon">ğŸ“¦</span> å•†å“ç®¡ç†
            </li>
            <li class="nav-item" onclick="switchTab('users', this)">
                <span class="nav-icon">ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†
            </li>
            <li class="nav-item home-link" onclick="window.location.href='ä¸»é¡µé¢.html'">
                <span class="nav-icon">ğŸ </span> è¿”å›å‰å°é¦–é¡µ
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="breadcrumb">åå°ç®¡ç† / <span id="pageTitle">å•†å“ç®¡ç†</span></div>
            <div class="admin-profile">
                <span class="admin-badge">ç®¡ç†å‘˜</span>
                <span style="font-size: 14px;" id="adminNameDisplay">Loading...</span>
                <button class="btn btn-danger" style="padding: 6px 12px; font-size:12px;" onclick="logout()">é€€å‡º</button>
            </div>
        </div>

        <div class="content-body">
            
            <div id="tab-products" class="card">
                <div class="card-header">
                    <h3 class="card-title">å…¨åº“å•†å“åˆ—è¡¨ (Database)</h3>
                    <button class="btn btn-primary" onclick="openProductModal()">+ æ–°å¢å•†å“</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">ID</th>
                                <th>å›¾ç‰‡</th>
                                <th>å“ç‰Œ</th>
                                <th>å•†å“åç§°</th>
                                <th>äº§åœ°</th>
                                <th>ä»·æ ¼</th>
                                <th>åº“å­˜</th>
                                <th style="width: 150px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <tr><td colspan="8" style="text-align:center;">æ­£åœ¨è¿æ¥æ•°æ®åº“...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-users" class="card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">æ³¨å†Œç”¨æˆ·åˆ—è¡¨</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>è§’è‰² (Role)</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="4" style="text-align:center;">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div class="modal" id="productModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; font-size:20px;" id="modalTitle">æ–°å¢å•†å“</h3>
                <span onclick="closeModal()" style="cursor:pointer; font-size:24px; color:#999;">&times;</span>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="p_id"> 
                <div class="form-group" style="margin-bottom: 15px; background: #fafafa; padding: 10px; border-radius: 4px; text-align: center; border: 1px dashed #ddd;">
                    <label style="cursor: pointer; color: var(--primary-color); font-weight: bold; display:block; padding:10px;">
                        ğŸ“¸ ç‚¹å‡»ä¸Šä¼ å•†å“å›¾ç‰‡
                        <input type="file" id="p_image" accept="image/*" style="display: none;" onchange="previewImage(this)">
                    </label>
                    <div id="imgPreview" style="margin-top: 10px; height: 120px; display: none; align-items: center; justify-content: center; overflow: hidden; background: #eee;">
                        <img id="previewTag" src="" style="height: 100%; border-radius: 4px;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å“ç‰Œ</label>
                        <input type="text" id="p_brand" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>äº§åœ°</label>
                        <input type="text" id="p_origin" class="form-control" required>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>å•†å“åç§°</label>
                    <input type="text" id="p_name" class="form-control" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç±»å‹</label>
                        <input type="text" id="p_type" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>ç„¦æ²¹é‡</label>
                        <input type="text" id="p_tar" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ä»·æ ¼</label>
                        <input type="text" id="p_price" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>åº“å­˜</label>
                        <input type="number" id="p_stock" class="form-control" required min="0">
                    </div>
                </div>
                <div style="text-align: right; margin-top: 25px; border-top:1px solid #eee; padding-top:20px;">
                    <button type="button" class="btn" onclick="closeModal()" style="margin-right:10px; background:#f5f5f5; color:#666;">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">ä¿å­˜æäº¤</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        const SERVER_URL = 'http://localhost:3000';
        let currentProducts = [];

        window.onload = function() {
            const currentUserStr = localStorage.getItem('gci_current_user');
            if (!currentUserStr) { alert('è¯·å…ˆç™»å½•ï¼'); window.location.href = 'ç™»å½•æ³¨å†Œ.html'; return; }
            const currentUser = JSON.parse(currentUserStr);
            if (currentUser.role !== 'admin') { alert('æƒé™ä¸è¶³'); window.location.href = 'ä¸»é¡µé¢.html'; return; }

            document.getElementById('adminNameDisplay').textContent = currentUser.username;
            fetchProducts();
        };

        // --- å•†å“ç®¡ç† ---
        async function fetchProducts() {
            try {
                const res = await fetch(`${API_BASE}/products`);
                if (!res.ok) throw new Error("ç½‘ç»œå“åº”å¼‚å¸¸");
                const data = await res.json();
                currentProducts = data; 
                renderTable(data);
            } catch (err) {
                console.error(err);
                document.getElementById('productTableBody').innerHTML = `<tr><td colspan="8" style="color:red; text-align:center;">æ— æ³•è¿æ¥æœåŠ¡å™¨ (${err.message})</td></tr>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = "";
            if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='8' style='text-align:center; color:#999; padding:20px;'>æš‚æ— æ•°æ®</td></tr>"; return; }
            data.forEach(p => {
                let stockClass = p.stock === 0 ? 'bg-danger' : (p.stock < 20 ? 'bg-warning' : 'bg-success');
                let thumbHtml = p.image ? `<img src="${SERVER_URL}${p.image}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;">` : `<div style="width:40px; height:40px; background:#eee; border-radius:4px;"></div>`;
                tbody.innerHTML += `<tr>
                    <td>#${p.id}</td><td>${thumbHtml}</td><td style="font-weight:bold;">${p.brand}</td><td>${p.name}</td><td>${p.origin}</td><td style="color:#d32f2f;">${p.price}</td>
                    <td><span class="status-badge ${stockClass}">${p.stock}</span></td>
                    <td><button class="btn btn-edit" onclick="editProduct(${p.id})">ç¼–è¾‘</button><button class="btn btn-danger" onclick="deleteProduct(${p.id})">åˆ é™¤</button></td>
                </tr>`;
            });
        }

        // --- æ ¸å¿ƒæ–°å¢ï¼šç”¨æˆ·ç®¡ç†é€»è¾‘ ---
        async function fetchUsers() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">æ­£åœ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨...</td></tr>`;
            try {
                const res = await fetch(`${API_BASE}/users`);
                const users = await res.json();
                
                tbody.innerHTML = "";
                if (users.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:#999;'>æš‚æ— ç”¨æˆ·</td></tr>";
                    return;
                }

                users.forEach(u => {
                    // å¦‚æœæ˜¯ adminï¼Œç»™ä¸ªç»¿è‰²æ ‡ç­¾ï¼Œæ™®é€šç”¨æˆ·ç»™ç°è‰²
                    let roleBadge = u.role === 'admin' 
                        ? `<span class="status-badge bg-success">ç®¡ç†å‘˜</span>` 
                        : `<span class="status-badge" style="background:#eee; color:#666;">æ™®é€šç”¨æˆ·</span>`;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>#${u.id}</td>
                            <td style="font-weight:bold;">${u.username}</td>
                            <td>${roleBadge}</td>
                            <td><span style="color:green;">æ­£å¸¸</span></td>
                        </tr>`;
                });
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
            }
        }

        // --- å…¶ä»–è¾…åŠ©é€»è¾‘ ---
        async function saveProduct(event) {
            event.preventDefault();
            const btn = document.getElementById('saveBtn'); btn.disabled = true; btn.textContent = "ä¸Šä¼ ä¸­...";
            const idStr = document.getElementById('p_id').value; 
            const formData = new FormData();
            formData.append('brand', document.getElementById('p_brand').value);
            formData.append('name', document.getElementById('p_name').value);
            formData.append('origin', document.getElementById('p_origin').value);
            formData.append('type', document.getElementById('p_type').value);
            formData.append('tar', document.getElementById('p_tar').value);
            formData.append('price', document.getElementById('p_price').value);
            formData.append('stock', document.getElementById('p_stock').value);
            const fileInput = document.getElementById('p_image');
            if (fileInput.files[0]) formData.append('image', fileInput.files[0]);

            try {
                let url = idStr ? `${API_BASE}/products/${idStr}` : `${API_BASE}/products`;
                let method = idStr ? 'PUT' : 'POST';
                const res = await fetch(url, { method: method, body: formData });
                if (res.ok) { alert('ä¿å­˜æˆåŠŸï¼'); closeModal(); fetchProducts(); } 
                else { const err = await res.json(); alert('ä¿å­˜å¤±è´¥: ' + err.error); }
            } catch (err) { alert('è¯·æ±‚å¤±è´¥: ' + err.message); } 
            finally { btn.disabled = false; btn.textContent = "ä¿å­˜æäº¤"; }
        }

        async function deleteProduct(id) {
            if (confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                await fetch(`${API_BASE}/products/${id}`, { method: 'DELETE' });
                fetchProducts();
            }
        }

        function switchTab(tabName, navElement) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            // æ’é™¤ "è¿”å›é¦–é¡µ" æŒ‰é’®ï¼Œä¸ç»™å®ƒåŠ  active æ ·å¼
            if (!navElement.classList.contains('home-link')) {
                navElement.classList.add('active');
            }
            
            document.getElementById('tab-products').style.display = tabName === 'products' ? 'block' : 'none';
            document.getElementById('tab-users').style.display = tabName === 'users' ? 'block' : 'none';
            document.getElementById('pageTitle').textContent = tabName === 'products' ? 'å•†å“ç®¡ç†' : 'ç”¨æˆ·ç®¡ç†';

            // å¦‚æœåˆ‡æ¢åˆ°ç”¨æˆ·ç®¡ç†ï¼Œè‡ªåŠ¨åˆ·æ–°æ•°æ®
            if (tabName === 'users') {
                fetchUsers();
            }
        }

        function previewImage(input) {
            const preview = document.getElementById('imgPreview');
            const tag = document.getElementById('previewTag');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { tag.src = e.target.result; preview.style.display = 'flex'; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        const modal = document.getElementById('productModal');
        function openProductModal(isEdit=false) {
            modal.style.display = 'flex';
            document.getElementById('modalTitle').textContent = isEdit ? 'ç¼–è¾‘å•†å“' : 'å½•å…¥æ–°å•†å“';
            document.getElementById('p_image').value = ''; document.getElementById('imgPreview').style.display = 'none';
            if (!isEdit) { document.getElementById('productForm').reset(); document.getElementById('p_id').value = ''; }
        }
        function editProduct(id) {
            const p = currentProducts.find(i => i.id === id);
            if (p) {
                document.getElementById('p_id').value = p.id;
                document.getElementById('p_brand').value = p.brand;
                document.getElementById('p_name').value = p.name;
                document.getElementById('p_origin').value = p.origin;
                document.getElementById('p_type').value = p.type;
                document.getElementById('p_tar').value = p.tar;
                document.getElementById('p_price').value = p.price;
                document.getElementById('p_stock').value = p.stock;
                if(p.image) { document.getElementById('previewTag').src = SERVER_URL + p.image; document.getElementById('imgPreview').style.display = 'flex'; }
                else { document.getElementById('imgPreview').style.display = 'none'; }
                openProductModal(true);
            }
        }
        function closeModal() { modal.style.display = 'none'; }
        window.onclick = (e) => { if (e.target == modal) closeModal(); }
        function logout() { if(confirm("ç¡®å®šé€€å‡ºï¼Ÿ")) { localStorage.removeItem('gci_current_user'); window.location.href = 'ç™»å½•æ³¨å†Œ.html'; } }
    </script>
</body>
</html>